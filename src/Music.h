#pragma once

#include <Arduino.h>

//=====================================================================//
/**
 * @file Music.h
 * Макросы для удобной записи песен в формате "линейных пар" (cmd, val).
 *
 * Идея:
 *  - Песня хранится как uint8_t[] PROGMEM и читается парами байт:
 *      [0] cmd/note, [1] val
 *      [2] cmd/note, [3] val
 *      ...
 *
 * Где:
 *  - cmd/note:
 *      * PAUSE (0)     — пауза (val = durFlags)
 *      * 1..127        — MIDI-нота
 *      * TEMPO (0xFF)  — смена темпа, val = tempo10 (например 9 -> 90 BPM)
 *      * TRANS (0xFE)  — транспозиция, val = int8 (например -1, 0, +1)
 *
 *  - val:
 *      * для нот/паузы — durFlags: длительность в 1/16 + флаги приёмов (STC/LGT/PMT)
 *      * для TEMPO     — tempo10: десятичное число *10 (9 -> 90 BPM, 12 -> 120 BPM)
 *      * для TRANS     — int8 semitone shift:
 *          0  = без сдвига
 *          1  = выше на полтона (MIDI+1)
 *         -1  = ниже на полтона (MIDI-1)
 *
 * Важно:
 *  - Конец песни (PAUSE, 0) больше НЕ используется. Длину трека нужно знать отдельно
 *    (например хранить длины в Songs.h).
 *
 * Пример записи:
 *  const uint8_t song0[] PROGMEM =
 *  {
 *      TEMPO, 9, TRANS, 0,       // 90 BPM, без транспозиции
 *      C4F, L08, D4F, L08,       // две восьмые
 *      E4F, (L04 | STC),         // четверть стаккато
 *      PAUSE, L08,               // пауза восьмая
 *      G4F, L4D                  // пунктирная четверть
 *  };
 *
 * Замечания:
 *  - "Точку" нельзя задавать отдельным бит-флагом (вроде L08 | DOT),
 *    потому что длительность кодируется числом (кол-вом 1/16) в младших 5 битах.
 *    Поэтому пунктирные длительности заданы отдельными константами L8D/L4D/L2D/L1D.
 *  - Флаги приёмов STC/LGT/PMT можно OR-ить с длительностью:
 *      (L08 | STC), (L04 | LGT), (L16 | PMT)
 *  - Для TRANS допускается писать отрицательные числа прямо в массиве:
 *      TRANS, -1
 *    В uint8_t это станет 255, а читать нужно как (int8_t)val.
 */
//=====================================================================//

//=====================================================================//
// Служебные ключи (cmd) в потоке [cmd, val] [cmd, val]...
//=====================================================================//

// TEMPO, tempo10: tempo = tempo10 * 10 BPM
// Пример: TEMPO, 9  -> 90 BPM
#define TEMPO				0xFF

// TRANS, int8: semitone shift (-1,0,+1,...)
// Пример: TRANS, -1 -> все ноты ниже на 1 полутон
#define TRANS				0xFE

// PAUSE: пауза (cmd = 0)
#define PAUSE				0

//=====================================================================//
// durFlags: младшие 5 бит — длительность (1/16), старшие 3 — приёмы
//=====================================================================//

// маска длины (кол-во 1/16)
#define DUR_MASK_16_COUNT	0x1F

// приёмы (можно OR-ить с L*):
//   C4F, (L08 | STC)  и т.п.
#define STC					0x20	// staccato
#define LGT					0x40	// legato
#define PMT					0x80	// palm mute

//=====================================================================//
// Длительности (val для ноты/паузы) — в 1/16, младшие 5 бит (0..31)
// 0 трактуем как 16/16 (целая нота), как и раньше.
//=====================================================================//

// Базовые
#define L16					1	// 1/16
#define L08					2	// 1/8
#define L04					4	// 1/4
#define L02					8	// 1/2
#define L01					0	// 1/1 (16/16 по правилу len16=0)

// Пунктирные (часто встречаются в MIDI после квантизации по 1/16)
#define L8D					3	// 3/16  = пунктирная 1/8
#define L4D					6	// 6/16  = пунктирная 1/4
#define L2D					12	// 12/16 = пунктирная 1/2
#define L1D					24	// 24/16 = пунктирная 1/1 (редко, но валидно)

//=====================================================================//
// Ноты (MIDI номера) + комментарии по октавам.
// Принята "MIDI octave numbering": C4 = 60 (middle C).
//
// Суффиксы:
//   F = "обычная" (натуральная)
//   D = диез (sharp)
//
// Диапазон ниже задан как C1..B7 (при необходимости можно расширить).
//=====================================================================//

//---------------------------------------------------------------------//
// Октава 1: C1..B1 (MIDI 24..35)
//---------------------------------------------------------------------//
#define C1F				24
#define C1D				25
#define D1F				26
#define D1D				27
#define E1F				28
#define F1F				29
#define F1D				30
#define G1F				31
#define G1D				32
#define A1F				33
#define A1D				34
#define B1F				35

//---------------------------------------------------------------------//
// Октава 2: C2..B2 (MIDI 36..47)
//---------------------------------------------------------------------//
#define C2F				36
#define C2D				37
#define D2F				38
#define D2D				39
#define E2F				40
#define F2F				41
#define F2D				42
#define G2F				43
#define G2D				44
#define A2F				45
#define A2D				46
#define B2F				47

//---------------------------------------------------------------------//
// Октава 3: C3..B3 (MIDI 48..59)
//---------------------------------------------------------------------//
#define C3F				48
#define C3D				49
#define D3F				50
#define D3D				51
#define E3F				52
#define F3F				53
#define F3D				54
#define G3F				55
#define G3D				56
#define A3F				57
#define A3D				58
#define B3F				59

//---------------------------------------------------------------------//
// Октава 4: C4..B4 (MIDI 60..71)  // C4 = middle C
//---------------------------------------------------------------------//
#define C4F				60
#define C4D				61
#define D4F				62
#define D4D				63
#define E4F				64
#define F4F				65
#define F4D				66
#define G4F				67
#define G4D				68
#define A4F				69
#define A4D				70
#define B4F				71

//---------------------------------------------------------------------//
// Октава 5: C5..B5 (MIDI 72..83)
//---------------------------------------------------------------------//
#define C5F				72
#define C5D				73
#define D5F				74
#define D5D				75
#define E5F				76
#define F5F				77
#define F5D				78
#define G5F				79
#define G5D				80
#define A5F				81
#define A5D				82
#define B5F				83

//---------------------------------------------------------------------//
// Октава 6: C6..B6 (MIDI 84..95)
//---------------------------------------------------------------------//
#define C6F				84
#define C6D				85
#define D6F				86
#define D6D				87
#define E6F				88
#define F6F				89
#define F6D				90
#define G6F				91
#define G6D				92
#define A6F				93
#define A6D				94
#define B6F				95

//---------------------------------------------------------------------//
// Октава 7: C7..B7 (MIDI 96..107)
//---------------------------------------------------------------------//
#define C7F				96
#define C7D				97
#define D7F				98
#define D7D				99
#define E7F				100
#define F7F				101
#define F7D				102
#define G7F				103
#define G7D				104
#define A7F				105
#define A7D				106
#define B7F				107
