# mid2code — MIDI → C-массив NoteEvent для MusicBox

Небольшая утилита для конвертации `.mid/.midi` в `uint8_t` поток команд вида `(cmd,val)` в формате, который ожидает прошивка MusicBox (через токены из `Music.h`).

В репозитории используются имена:
- `mid2code.py` — конвертер
- `mid2code.bat` — удобный запуск под Windows (drag&drop)

---

## Требования

- Python 3.x
- Библиотека **mido**

Установка:
```bash
pip install mido
```

---

## Быстрый старт (Windows / Drag & Drop)

1. Установите Python и добавьте его в `PATH`.
2. Установите `mido`:
   ```bat
   pip install mido
   ```
3. Положите `mid2code.bat` и `mid2code.py` в одну папку.
4. Перетащите `.mid` / `.midi` файл на `mid2code.bat`.

Результат: рядом с MIDI-файлом будет создан `.txt` с C-кодом (имя массива берётся из имени файла и приводится к безопасному идентификатору).

---

## Запуск из консоли (любая ОС)

Конвертация:
```bash
python mid2code.py input.mid --name song0 > out.txt
```

Инспекция MIDI (полезно для диагностики треков/темпов/размера):
```bash
python mid2code.py input.mid --inspect
```

---

## Что получается на выходе

Вывод — C-массив вида:
```c
const uint8_t song0[] PROGMEM =
{
    TEMPO, 12, TRANS, 0,   // ~120 BPM
    C4F, L08, D4F, L08,    // такт 1
    ...
};
```

---

## Правила конвертации (коротко)

- **Моно:** в каждый момент времени выбирается **самая высокая** активная нота.
- Длительность режется по ближайшему MIDI событию (note_on / note_off / переход в паузу).
- **TEMPO** берётся из `set_tempo` и вставляется как `TEMPO, tempo10` по позициям.
- **TRANS** из MIDI не извлекается: по умолчанию вставляется `TRANS, 0` сразу после первого `TEMPO`.
    - Если передать `--transpose N`, то это попадёт в initial `TRANS`, **но ноты не транспонируются** (только значение команды).
- Длительности раскладываются на “красивые” куски: `16,12,8,6,4,3,2,1` (токены `L01,L2D,L02,L4D,L04,L8D,L08,L16`).
- Конец песни `PAUSE,0` **не добавляется** (по договорённости).
- Важный фикс: **одинаковые ноты подряд не склеиваются** — каждая нота остаётся отдельным “триггером”.

---

## Структура файлов

Минимально достаточно:
- `mid2code.py`
- `mid2code.bat` (если нужен drag&drop под Windows)

---

## Подсказки

- Если конвертация “пустая” или странная — сначала сделайте:
  ```bash
  python mid2code.py input.mid --inspect
  ```
- Если в MIDI несколько треков, скрипт берёт **первый трек, где реально есть note_on/note_off**.
